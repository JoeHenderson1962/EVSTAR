/*!
 * ParamQuery grid knockout bindings v4.0.3
 *
 * Copyright (c) 2016-2017 Paramvir Dhindsa (http://paramquery.com)
 * Released under Commercial license
 * http://paramquery.com/pro/license
 *
 */
!function(t){"use strict";var e=t.paramquery.pqGrid.prototype;e.totalRows=e.totalRows||function(){var t=this.options.dataModel,e=t.data,o=t.dataUF||[];return e.length+o.length};var o=pq.ko={cBind:function(e,n,i){var r,a,s=this,d=n(),u=o.timeFactory.timer(),c=o.timeFactory.timer(),l=d.colModel,f=d.koModel||{},p=o.readCellTemplates(l||[])||f.bind,h=d.dataModel,g=h.data,m=f.item,w="function"==typeof g?g:null;d.refresh=function(){p&&s.onRefresh(this)},s.element=e,s.timerItem=o.timeFactory.timer(),s.context=i,w&&(r=w(),m||!r[0]||t.isPlainObject(r[0])||(m=r[0].constructor),d.dataModel.data=s.importData(r,m),s.subscribeKoDataChange(w,m,u)),s.koItem=m,a=pq.grid(e,d),s.grid=a,a.on("sort filter load",s.onSortFilterLoad(s,w,m,c)).on("change",s.onChange(s,w,m,c)).on("refreshRow refreshCell",s.onRefreshRowCell(s,p)),ko.utils.domNodeDisposal.addDisposeCallback(e,function(){a.destroy()})},disposeRow:function(t){var e,o=t.pq_ko;if(o)for(e in o)o[e].dispose()},readCellTemplates:function(t){for(var e,o,n,i=0,r=t.length;r>i;i++)e=t[i],(o=e.template)&&(n=!0,e.render=function(t){return function(e){return t}}(o));return n},timeFactory:{timer:function(){var t;return{setTimeout:function(e){t&&ko.tasks.cancel(t),t=ko.tasks.schedule(e)}}}}};pq.ko.cBind.prototype={disposeData:function(){for(var t=this.grid.option("dataModel.data"),e=o.disposeRow,n=0,i=t.length;i>n;n++)e(t[n])},exportRow:function(t,e){var o,n,i,r=t.pq_ko_item;if(r)for(i in r)r[i](t[i]);else{r=new e(t),t.pq_ko=o=t.pq_ko||{};for(i in r)n=r[i],this.subscribe(n,t,i,o)}return r},exportData:function(t){var e,o=this,n=o.grid.options.dataModel.data,i=[];return t?(ko.utils.arrayMap(n,function(n){e=o.exportRow(n,t),i.push(e)}),i):n},importArrayChanges:function(t,e){var n,i,r,a,s=t.length,d=this.grid.option("dataModel.data");if(s>d.length)return!0;for(;s--;)i=t[s],r=i.status,a=i.index,"added"==r?(n=this.importRow(i.value,e),d.splice(a,0,n)):"deleted"==r&&(o.disposeRow(d[a]),d.splice(a,1))},importData:function(t,e){var o=[],n=this;return e?(ko.utils.arrayMap(t,function(t){o.push(n.importRow(t,e))}),o):t},importRow:function(t,e){var o,n,i;if(e){i={},o={pq_ko:i};for(var r in t)n=t[r],this.subscribe(n,o,r,i),o[r]=n();return o.pq_ko_item=t,o}return t},onChange:function(t,e,o,n){return function(i,r){if(e){var a=r.updateList;if(1!=a.length||r.addList.length||r.deleteList.length)t.inChange=!0,n.setTimeout(function(){e(t.exportData(o)),t.inChange=!1});else{var s=a[0],d=s.rowData.pq_ko_item,u=s.newRow;if(d)for(var c in u)d[c](u[c])}}}},onRefresh:function(e){for(var o,n,i,r=0,a=e.$cont.children().children().children().children(".pq-grid-row:not('.pq-detail-child')"),s=a.length;s>r;r++)i=t(a[r]),o=e.getRowIndx({$tr:i}),n=e.getRowData(o),ko.cleanNode(i[0]),this.rowScope(i,n,o.rowIndx)},onRefreshRowCell:function(t,e){return function(o,n){if(e){var i=this.getRow(n);ko.cleanNode(i[0]),t.rowScope(i,n.rowData,n.rowIndx)}}},onSortFilterLoad:function(t,e,o,n){return function(i){e&&(t.inChange=!0,n.setTimeout(function(){e(t.exportData(o)),t.inChange=!1}))}},rowScope:function(t,e,o){var n=this.context.extend({rd:e.pq_ko_item||e,ri:o});ko.applyBindingsToDescendants(n,t[0])},subscribe:function(t,e,o,n){var i=this.timerItem,r=this;n[o]=n[o]||t.subscribe(function(t){e[o]=t,i.setTimeout(function(){r.grid.refresh({header:!1})})})},subscribeKoDataChange:function(t,e,o){var n,i,r=this;t&&(t.subscribe(function(t){r.inChange||n||(n=!e||r.importArrayChanges(t,e),o.setTimeout(function(){r.grid.refreshView()}))},null,"arrayChange"),t.subscribe(function(a){if(!r.inChange&&n){if(t()!=a)throw"koData != arr assert failed";i=r.grid,o.setTimeout(function(){e&&r.disposeData(),i.option("dataModel.data",r.importData(t(),e)),i.refreshView()}),n=!1}}))}},ko.bindingHandlers.pqGrid={init:function(t,e,n,i,r){return new o.cBind(t,e,r),{controlsDescendantBindings:!0}}}}(jQuery);